{% extends 'base.html' %}

{% block title %}{{ template.template_name }} - Minibini{% endblock %}

{% block navigation %}
{% include 'includes/settings_navigation.html' %}
{% endblock %}

{% block content %}
<style>
    .bundle-group-row {
        background-color: #e8f0fe;
    }
    .bundle-task-row {
        background-color: #f0f7ff;
    }
    .bundle-header {
        font-weight: bold;
        color: #2c5282;
    }
    .excluded-task {
        opacity: 0.5;
        font-style: italic;
    }
    .reorder-btn {
        padding: 2px 6px;
        font-size: 12px;
        cursor: pointer;
        border: 1px solid #ccc;
        background: #fff;
    }
</style>

<h2>Work Order Template: {{ template.template_name }}</h2>

<table border="1">
    <tr><th>Field</th><th>Value</th></tr>
    <tr><td>Template ID</td><td>{{ template.template_id }}</td></tr>
    <tr><td>Template Name</td><td>{{ template.template_name }}</td></tr>
    <tr><td>Description</td><td>{{ template.description|default:"-" }}</td></tr>
    <tr><td>Active</td><td>{{ template.is_active|yesno:"Yes,No" }}</td></tr>
    <tr><td>Created Date</td><td>{{ template.created_date }}</td></tr>
</table>

<h3>Task Templates</h3>

{% if container_items %}
<table border="1">
    <tr>
        <th style="width: 30px;"></th>
        <th>Task Name</th>
        <th>Description</th>
        <th>Units</th>
        <th>Rate</th>
        <th>Est. Qty</th>
        <th>Mapping</th>
        <th>Order</th>
        <th>Action</th>
    </tr>

    {% for item_type, item_data, sort_order in container_items %}
        {% if item_type == 'bundle' %}
        <tr class="bundle-group-row">
            <td></td>
            <td class="bundle-header" colspan="5">
                Bundle: "{{ item_data.bundle.name }}" ({{ item_data.bundle.line_item_type.name }})
            </td>
            <td></td>
            <td>
                <form method="post" action="{% url 'jobs:template_reorder_item' template.template_id 'bundle' item_data.bundle.pk 'up' %}" style="display:inline">
                    {% csrf_token %}<button type="submit" class="reorder-btn">&#9650;</button>
                </form>
                <form method="post" action="{% url 'jobs:template_reorder_item' template.template_id 'bundle' item_data.bundle.pk 'down' %}" style="display:inline">
                    {% csrf_token %}<button type="submit" class="reorder-btn">&#9660;</button>
                </form>
            </td>
            <td></td>
        </tr>
        {% for association in item_data.associations %}
        <tr class="bundle-task-row">
            <td>
                <form method="post" id="select-form" style="display:inline">
                    <input type="checkbox" name="selected_tasks" value="{{ association.pk }}" form="bundle-form">
                </form>
            </td>
            <td style="padding-left: 20px;">{{ association.task_template.template_name }}</td>
            <td>{{ association.task_template.description|truncatewords:10|default:"-" }}</td>
            <td>{{ association.task_template.units|default:"-" }}</td>
            <td>${{ association.task_template.rate|default:"0.00" }}</td>
            <td>{{ association.est_qty }}</td>
            <td>{{ item_data.bundle.name }}</td>
            <td>
                <form method="post" action="{% url 'jobs:template_reorder_in_bundle' template.template_id association.pk 'up' %}" style="display:inline">
                    {% csrf_token %}<button type="submit" class="reorder-btn">&#9650;</button>
                </form>
                <form method="post" action="{% url 'jobs:template_reorder_in_bundle' template.template_id association.pk 'down' %}" style="display:inline">
                    {% csrf_token %}<button type="submit" class="reorder-btn">&#9660;</button>
                </form>
            </td>
            <td>
                <form method="post" style="display:inline">
                    {% csrf_token %}
                    <button type="submit" name="remove_task" value="{{ association.task_template.template_id }}"
                             class="reorder-btn">Unbundle</button>
                </form>
            </td>
        </tr>
        {% endfor %}

        {% else %}
        {# item_type == 'task' - unbundled association #}
        <tr{% if item_data.mapping_strategy == 'exclude' %} class="excluded-task"{% endif %}>
            <td>
                <input type="checkbox" name="selected_tasks" value="{{ item_data.pk }}" form="bundle-form">
            </td>
            <td>{{ item_data.task_template.template_name }}</td>
            <td>{{ item_data.task_template.description|truncatewords:10|default:"-" }}</td>
            <td>{{ item_data.task_template.units|default:"-" }}</td>
            <td>${{ item_data.task_template.rate|default:"0.00" }}</td>
            <td>{{ item_data.est_qty }}</td>
            <td>{% if item_data.mapping_strategy == 'exclude' %}Exclude (internal){% else %}Direct{% endif %}</td>
            <td>
                <form method="post" action="{% url 'jobs:template_reorder_item' template.template_id 'task' item_data.pk 'up' %}" style="display:inline">
                    {% csrf_token %}<button type="submit" class="reorder-btn">&#9650;</button>
                </form>
                <form method="post" action="{% url 'jobs:template_reorder_item' template.template_id 'task' item_data.pk 'down' %}" style="display:inline">
                    {% csrf_token %}<button type="submit" class="reorder-btn">&#9660;</button>
                </form>
            </td>
            <td>
                <form method="post" style="display:inline">
                    {% csrf_token %}
                    <button type="submit" name="remove_task" value="{{ item_data.task_template.template_id }}"
                             class="reorder-btn">Remove</button>
                </form>
            </td>
        </tr>
        {% endif %}
    {% endfor %}
</table>
{% else %}
<p>No task templates found for this work order template.</p>
{% endif %}

<h4>Create Bundle from Selected Tasks</h4>
<form method="post" id="bundle-form">
    {% csrf_token %}
    <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
        <div>
            <label for="bundle_name">Bundle Name:</label>
            <input type="text" name="bundle_name" id="bundle_name" style="width: 200px;">
        </div>
        <div>
            <label for="bundle_description">Description (optional):</label>
            <input type="text" name="bundle_description" id="bundle_description" style="width: 300px;">
        </div>
        <div>
            <label for="line_item_type">Line Item Type:</label>
            <select name="line_item_type" id="line_item_type">
                <option value="">-- Select Type --</option>
                {% for lit in line_item_types %}
                <option value="{{ lit.pk }}">{{ lit.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="margin-top: 10px;">
            <button type="submit" name="bundle_tasks">Bundle Selected Tasks</button>
        </div>
    </div>
</form>

{% if available_templates %}
<h4>Associate Existing Task Template</h4>
<form method="post">
    {% csrf_token %}
    <div>
        <label for="task_template_id">Task Template:</label>
        <select name="task_template_id" required>
            <option value="">-- Select Task Template --</option>
            {% for task in available_templates %}
            <option value="{{ task.template_id }}">{{ task.template_name }} ({{ task.units|default:"no units" }}, ${{ task.rate|default:"0.00" }})</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label for="est_qty">Estimated Quantity:</label>
        <input type="number" name="est_qty" step="0.01" value="1.00" min="0" required>
    </div>
    <button type="submit" name="associate_task">Associate Task Template</button>
</form>
{% else %}
<h4>All available task templates are already associated with this work order template.</h4>
{% endif %}

<p>
    <a href="{% url 'jobs:work_order_template_list' %}">Back to Templates List</a>
</p>

{% endblock %}

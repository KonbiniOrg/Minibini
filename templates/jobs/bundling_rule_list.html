{% extends 'base.html' %}

{% block title %}Bundling Rules - Minibini{% endblock %}

{% block navigation %}
{% include 'includes/settings_navigation.html' %}
{% endblock %}

{% block content %}
<h2>Bundling Rules</h2>

<div style="background-color: #f0f0f0; padding: 10px; margin-bottom: 20px; border-left: 4px solid #007bff;">
    <strong>About Bundling Rules</strong>
    <p>Bundling Rules define how multiple worksheet tasks combine into a single estimate line item. They work with Task Mappings that use the "bundle" strategy.</p>
    <p><strong>Example:</strong> A cabinet has separate tasks for frame, doors, and hardware. A bundling rule combines these into one line item "Custom Cabinet - cabinet_001" with a total price.</p>
</div>

<p>
    <a href="{% url 'jobs:bundling_rule_create' %}" style="background-color: #007bff; color: white; padding: 5px 10px; text-decoration: none;">Add New Rule</a>
    {% if show_all %}
        | <a href="{% url 'jobs:bundling_rule_list' %}">Hide Inactive</a>
    {% else %}
        | <a href="{% url 'jobs:bundling_rule_list' %}?show_all=1">Show All</a>
    {% endif %}
</p>

{% if rules %}
<table border="1">
    <thead>
        <tr>
            <th>Rule Name</th>
            <th>Product Type</th>
            <th>Pricing Method</th>
            <th>Combine?</th>
            <th>Active</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for rule in rules %}
        <tr{% if not rule.is_active %} style="opacity: 0.5;"{% endif %}>
            <td>{{ rule.rule_name }}</td>
            <td>{{ rule.product_type }}</td>
            <td>{{ rule.get_pricing_method_display }}</td>
            <td>{% if rule.combine_instances %}Yes{% else %}No{% endif %}</td>
            <td>{% if rule.is_active %}Yes{% else %}No{% endif %}</td>
            <td>
                <a href="{% url 'jobs:bundling_rule_detail' rule.pk %}">View</a> |
                <a href="{% url 'jobs:bundling_rule_edit' rule.pk %}">Edit</a> |
                <a href="{% url 'jobs:bundling_rule_delete' rule.pk %}" style="color: #dc3545;">Delete</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No bundling rules found. <a href="{% url 'jobs:bundling_rule_create' %}">Create your first rule</a>.</p>
{% endif %}

<h3>How Bundling Works</h3>
<ol>
    <li>Tasks with <code>bundle</code> mapping strategy are grouped by bundle_identifier</li>
    <li>The bundling rule matching the product_type is applied</li>
    <li>Component prices are combined based on the pricing method</li>
    <li>Quantity is determined by default_units: "each" = qty 1, "hours" = sum of task hours</li>
    <li>One line item is created with a description like "Custom Cabinet - kitchen_island"</li>
</ol>

<p><a href="{% url 'settings' %}">Back to Settings</a></p>
{% endblock %}

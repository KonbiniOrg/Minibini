{% extends 'base.html' %}

{% block title %}Generate Estimate from Worksheet {{ worksheet.est_worksheet_id }} - Minibini{% endblock %}

{% block content %}
<h2>Generate Estimate from Worksheet #{{ worksheet.est_worksheet_id }}</h2>

<h3>Worksheet Details</h3>
<table border="1">
    <tr><th>Job</th><td>{{ worksheet.job.job_number }} - {{ worksheet.job.description }}</td></tr>
    <tr><th>Status</th><td>{{ worksheet.get_status_display }}</td></tr>
    <tr><th>Total Tasks</th><td>{{ tasks.count }}</td></tr>
    <tr><th>Total Cost</th><td>${{ total_cost|floatformat:2 }}</td></tr>
</table>

<h3>Tasks to be included in estimate:</h3>
<table border="1">
    <tr>
        <th>Task Name</th>
        <th>Cost</th>
        <th>Line Item Type</th>
        <th>Will be included?</th>
    </tr>
    {% for task in tasks %}
    <tr>
        <td>{{ task.name }}</td>
        <td>
            {% if task.rate and task.est_qty %}
                ${{ task.rate|floatformat:2 }} x {{ task.est_qty|floatformat:2 }}
            {% else %}
                $0.00
            {% endif %}
        </td>
        <td>
            {% if task.line_item_type %}
                {{ task.line_item_type }}
            {% elif task.mapping_strategy == 'bundle' %}
                (via bundle)
            {% else %}
                -
            {% endif %}
        </td>
        <td>
            {% if task.mapping_strategy == 'exclude' %}
                No (internal task)
            {% else %}
                Yes
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>

{% if untyped_tasks %}
<h3>Assign Line Item Types</h3>
<p>These tasks need a line item type before generating:</p>
<form method="post">
    {% csrf_token %}
    <table border="1">
        <tr>
            <th>Task</th>
            <th>Line Item Type</th>
        </tr>
        {% for task in untyped_tasks %}
        <tr>
            <td>{{ task.name }}</td>
            <td>
                <select name="task_line_item_type_{{ task.pk }}" required>
                    <option value="">-- Select --</option>
                    {% for lit in line_item_types %}
                    <option value="{{ lit.pk }}">{{ lit.name }}</option>
                    {% endfor %}
                </select>
            </td>
        </tr>
        {% endfor %}
    </table>
    <p>
        <button type="submit">Assign Types &amp; Generate Estimate</button>
        <a href="{% url 'jobs:estworksheet_detail' worksheet.est_worksheet_id %}">Cancel</a>
    </p>
</form>
{% else %}
<h3>Generate Estimate</h3>
<p>Click the button below to generate a new estimate from this worksheet.</p>
<form method="post">
    {% csrf_token %}
    <button type="submit">Generate Estimate Now</button>
    <a href="{% url 'jobs:estworksheet_detail' worksheet.est_worksheet_id %}">Cancel</a>
</form>
{% endif %}

{% endblock %}
